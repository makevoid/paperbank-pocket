// Generated by CoffeeScript 1.12.4
var Bip38, bindRegenerate, bip38, bitcore, generateQRs, main, makeQR, promptForPassword, regenerate;

makeQR = require('./make-qr');

bitcore = require('bitcore-lib');

Bip38 = require('bip38');

bip38 = new Bip38();

main = function() {
  var address, privateKey;
  privateKey = new bitcore.PrivateKey;
  address = privateKey.toAddress();
  return promptForPassword(function(password) {
    generateQRs(address, privateKey, password);
    return bindRegenerate(address, privateKey, password);
  });
};

promptForPassword = function(callback) {
  var password, password2;
  password = prompt("Choose a BIP38 Password to encrypt your paper wallet");
  password2 = prompt("Confirm the BIP38 Password you chose");
  if (password && password === password2 && password !== "") {
    return callback(password);
  } else {
    alert("Password mismatch! Close this alert and try entering the password again.");
    return promptForPassword(callback);
  }
};

generateQRs = function(address, privateKey, password) {
  var progBar;
  progBar = document.querySelector(".progress");
  return setTimeout(function() {
    var addrElem, keyElem, privateKeyBip38;
    privateKeyBip38 = bip38.encrypt(privateKey.toWIF(), password, address.toString(), function(prog) {
      var perc;
      perc = Math.round(prog.percent);
      progBar.style.width = perc + "%";
      if (perc === 100) {
        return setTimeout(function() {
          return progBar.style.width = "0%";
        }, 3000);
      }
    });
    makeQR("qr_private_key", privateKeyBip38);
    makeQR("qr_address", address.toString());
    keyElem = document.querySelector(".private_key_label");
    addrElem = document.querySelector(".address_label");
    keyElem.innerHTML = privateKeyBip38;
    return addrElem.innerHTML = address.toString();
  }, 0);
};

regenerate = function(address, privateKey, password) {
  return function() {
    return generateQRs(address, privateKey, password);
  };
};

bindRegenerate = function(address, privateKey, password) {
  var elem;
  elem = document.querySelector("a.regenerate");
  return elem.addEventListener("click", regenerate(address, privateKey, password));
};

main();
